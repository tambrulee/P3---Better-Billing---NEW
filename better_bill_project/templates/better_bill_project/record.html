{% extends "base.html" %}
{# templates/record.html #}

<!-- Page Title -->
{% block title %}Home{% endblock %}

<!-- Main Section -->
{% block content %}
<main class="container py-4">
    <!-- Page Title -->
   <h2 class="page-title">Record Hours</h2>
<!-- Validation message if submission successful -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      {% if "invoice" not in message.tags %}
        <div class="alert alert-{{ message.level_tag }} mb-2">{{ message }}</div>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}

<!-- Record Time Form -->
  <form method="post" action="{% url 'record-time' %}" novalidate>
    {% csrf_token %}

    <div class="row g-3">

      <!-- Client (helper field for narrowing matters) -->
      <div class="col-md-6">
        <label for="{{ form.client.id_for_label }}" class="form-label">Client</label>
        {{ form.client }}
        {% if form.client.errors %}<div class="text-danger small">{{ form.client.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Matter -->
      <div class="col-md-6">
        <label for="{{ form.matter.id_for_label }}" class="form-label">Matter</label>
        {{ form.matter }}
        {% if form.matter.errors %}<div class="text-danger small">{{ form.matter.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Fee earner -->
      <div class="col-md-6">
        <label for="{{ form.fee_earner.id_for_label }}" class="form-label">Fee Earner</label>
        {{ form.fee_earner }}
        {% if form.fee_earner.errors %}<div class="text-danger small">{{ form.fee_earner.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Activity code -->
      <div class="col-md-6">
        <label for="{{ form.activity_code.id_for_label }}" class="form-label">Activity Code</label>
        {{ form.activity_code }}
        {% if form.activity_code.errors %}<div class="text-danger small">{{ form.activity_code.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Hours -->
      <div class="col-md-6">
        <label for="{{ form.hours_worked.id_for_label }}" class="form-label">Hours Worked</label>
        {{ form.hours_worked }}
        <div class="form-text">{{ form.fields.hours_worked.help_text }}</div>
        {% if form.hours_worked.errors %}<div class="text-danger small">{{ form.hours_worked.errors|striptags }}</div>{% endif %}
      </div>

      <!-- Narrative -->
      <div class="col-12">
        <label for="{{ form.narrative.id_for_label }}" class="form-label">Narrative</label>
        {{ form.narrative }}
        {% if form.narrative.errors %}<div class="text-danger small">{{ form.narrative.errors|striptags }}</div>{% endif %}
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-success">Save Entry</button>
      <a href="{% url 'record-time' %}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

<!-- Time Entry Table -->
<!-- Partner only view -->
  {% if is_partner %}
<form method="get" class="card shadow-sm mb-3">
  <div class="card-body d-flex flex-wrap align-items-end gap-2">
    <div>
      <label class="form-label mb-1">Fee Earner</label>
      <select name="fe" class="form-select">
        <option value="">— Everyone —</option>
        {% for p in fee_earners %}
          <option value="{{ p.id }}" {% if selected_fe == p.id|stringformat:'s' %}selected{% endif %}>
            {{ p.initials }} — {{ p.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="ms-auto">
      <button class="btn btn-primary">Apply</button>
      <a href="{% url 'record-time' %}" class="btn btn-outline-secondary">Clear</a>
    </div>
  </div>
</form>
{% endif %}

<!-- Recent Entries -->
{% if recent_entries %}
  <hr>
  <div class="d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Recent Entries</h3>
    <span class="small text-muted">
      {% if is_partner %}
        {% if selected_fe %}Filtered{% else %}All fee earners{% endif %}
      {% else %}
        Showing your entries
      {% endif %}
    </span>
  </div>

  <div class="table-responsive mt-2">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Matter</th>
          <th>Fee Earner</th>
          <th>Hours</th>
          <th>Narrative</th>
          <th>Status</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
  {% for e in recent_entries %}
    <tr>
      <td>{{ e.created_at|date:"Y-m-d H:i" }}</td>
      <td>{{ e.matter.matter_number }}</td>
      <td>{{ e.fee_earner.initials }}</td>
      <td>{{ e.hours_worked }}</td>
      <td class="small text-muted">{{ e.narrative }}</td>

      {# STATUS BADGE #}
      <td>
        {% if e.wip and e.wip.status == "unbilled" %}
          <span class="badge text-bg-warning">Unbilled</span>
        {% elif e.wip and e.wip.status == "billed" %}
          <span class="badge text-bg-success">Billed</span>
        {% elif e.wip and e.wip.status == "written_off" %}
          <span class="badge text-bg-secondary">Written off</span>
        {% else %}
          <span class="badge text-bg-light text-muted">—</span>
        {% endif %}
      </td>

      {# ACTIONS #}
      <td class="text-end">
        {% if e.wip and e.wip.status == "unbilled" %}
          {% if is_partner or e.fee_earner_id == me_personnel_id %}
            <div class="btn-group btn-group-sm" role="group" aria-label="Actions">
              <button class="btn btn-outline-primary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#editRow{{ e.id }}">
                Edit
              </button>

              <form method="post" action="{% url 'timeentry-delete' e.id %}" class="d-inline">
                {% csrf_token %}
                {% if selected_fe %}
                  <input type="hidden" name="fe" value="{{ selected_fe }}">
                {% endif %}
                <button type="submit" class="btn btn-outline-danger"
                        onclick="return confirm('Delete this unbilled entry?')">
                  Delete
                </button>
              </form>
            </div>
          {% else %}
            <button class="btn btn-sm btn-outline-secondary" disabled>No access</button>
          {% endif %}
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>Locked</button>
        {% endif %}
      </td>
    </tr>

    {# INLINE QUICK-EDIT FORM (only meaningful when allowed) #}
    <tr class="collapse" id="editRow{{ e.id }}">
  <td colspan="7">
    {% if e.wip and e.wip.status == "unbilled" %}
      {% if is_partner or e.fee_earner_id == me_personnel_id %}
        <form method="post" class="card card-body border-0 bg-light">
          {% csrf_token %}
          <input type="hidden" name="update_id" value="{{ e.id }}">
          {% if selected_fe %}
            <input type="hidden" name="fe" value="{{ selected_fe }}">
          {% endif %}

          <div class="row g-2">
            <div class="col-md-2">
              <label class="form-label">Hours</label>
              <input name="hours_worked" type="number" step="0.1" min="0"
                     class="form-control" value="{{ e.hours_worked }}">
            </div>

            <div class="col-md-3">
              <label class="form-label">Activity</label>
              <select name="activity_code" class="form-select">
                {% for ac in activity_codes %}
                  <option value="{{ ac.id }}" {% if ac.id == e.activity_code_id %}selected{% endif %}>
                    {{ ac.activity_code }} — {{ ac.activity_description }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-7">
              <label class="form-label">Narrative</label>
              <textarea name="narrative" rows="2" class="form-control">{{ e.narrative }}</textarea>
            </div>
          </div>

          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-success btn-sm" type="submit">Save</button>
            <button class="btn btn-outline-secondary btn-sm" type="button"
                    data-bs-toggle="collapse" data-bs-target="#editRow{{ e.id }}">Cancel</button>
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning mb-0">You can’t edit this entry.</div>
      {% endif %}
    {% else %}
      <div class="alert alert-warning mb-0">This entry is locked.</div>
    {% endif %}
  </td>
</tr>

  {% endfor %}
</tbody>

    </table>
  </div>
{% endif %}

</main>

{% endblock %}

<!-- Scripts (pulls in bootstrap)-->
{% block body_end %}
<!-- Time Entry JS -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('id_client');
    const matterSelect = document.getElementById('id_matter');
    const url = "{% url 'ajax-matter-options' %}";

    async function loadMatters(clientId) {
      try {
        const resp = await fetch(`${url}?client=${clientId}`, {headers: {'X-Requested-With':'XMLHttpRequest'}});
        matterSelect.innerHTML = await resp.text();
      } catch (e) {
        console.error(e);
        matterSelect.innerHTML = '<option value="">— Unable to load matters —</option>';
      }
    }

    clientSelect.addEventListener('change', (e) => {
      const cid = e.target.value;
      if (cid) loadMatters(cid);
      else matterSelect.innerHTML = '<option value="">— Select matter —</option>';
    });

    // Preload matters if a client is already selected (e.g. after validation errors)
    if (clientSelect.value) loadMatters(clientSelect.value);
  });
  </script>
{% endblock %}

