<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Billing - Create Invoice</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Custom CSS -->
     {% load static %}
     <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/better_bill_logo.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/better_bill_logo.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/better_bill_logo.png' %}">
</head>
<body>
<header class="sticky-top">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm" data-bs-theme="light">
    <div class="container">
      <!-- Brand -->
      <a class="navbar-brand fw-bold" href="{% url 'index' %}">Better Billing</a>

      <!-- Mobile toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Collapsible area -->
      <div class="collapse navbar-collapse" id="mainNav">
        {% with url_name=request.resolver_match.url_name %}
        <!-- Left side: primary nav -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'index' %}active{% endif %}"
               aria-current="{% if url_name == 'index' %}page{% endif %}"
               href="{% url 'index' %}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'record-time' %}active{% endif %}"
               aria-current="{% if url_name == 'record-time' %}page{% endif %}"
               href="{% url 'record-time' %}">Record Hours</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'create-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'create-invoice' %}page{% endif %}"
               href="{% url 'create-invoice' %}">Create Invoice</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'view-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'view-invoice' %}page{% endif %}"
               href="{% url 'view-invoice' %}">View Invoice</a>
          </li>

          {% if perms.better_bill_project.post_invoice %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'post-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'post-invoice' %}page{% endif %}"
               href="{% url 'post-invoice' %}">Post/Delete Invoices</a>
          </li>
          {% endif %}
        </ul>
        {% endwith %}

        <!-- Right side: login/user info from partial -->
        <div class="navbar-nav ms-auto align-items-lg-center gap-2">
          {% include "partials/_topbar.html" %}
        </div>
      </div>
    </div>
  </nav>

</header>

  <!-- Page Title -->
   <h2 class="page-title">Create Invoice </h2>

<main class="container pb-5">
<!-- Validation message if submission successful -->
  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      {% if "invoice" in message.tags %}
        <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}


  <form method="post" class="card shadow-sm mb-4">
    <div class="card-body">
      {% csrf_token %}

      <div class="row g-3">
  <!-- Invoice #: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Invoice #</label>
    <input class="form-control" value="{{ readonly_number }}" disabled>
  </div>

  <!-- Invoice date: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Invoice Date</label>
    <input class="form-control" value="{{ readonly_date }}" disabled>
  </div>

  <!-- Tax %: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Tax %</label>
    <input class="form-control" value="{{ readonly_tax }}" disabled>
  </div>

  <div class="col-md-6">
    <label class="form-label" for="{{ form.client.id_for_label }}">Client</label>
    {{ form.client }}
  </div>
  <div class="col-md-6">
    <label class="form-label" for="{{ form.matter.id_for_label }}">Matter</label>
    {{ form.matter }}
  </div>

  <div class="col-12">
    <label class="form-label" for="{{ form.notes.id_for_label }}">Work Summary</label>
    {{ form.notes }}
  </div>
</div>


      <hr>

      <h5 class="mb-3">Select WIP items to include</h5>
      <p class="text-muted">Choose a Client (and optionally a Matter) to see unbilled WIP.</p>

      {% if wip_items %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:2rem"></th>
                <th>Created</th>
                <th>Matter</th>
                <th>Fee Earner</th>
                <th>Hours</th>
                <th>Activity</th>
                <th>Narrative</th>
              </tr>
            </thead>
            <tbody>
              {% for w in wip_items %}
              <tr>
                <td><input type="checkbox" name="wip_ids" value="{{ w.id }}"></td>
                <td>{{ w.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ w.matter.matter_number }}</td>
                <td>{{ w.fee_earner.initials }}</td>
                <td>{{ w.hours_worked }}</td>
                <td>{{ w.activity_code }}</td>
                <td class="text-truncate" style="max-width:420px">{{ w.narrative }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No unbilled WIP found for the current selection.</div>
      {% endif %}

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-success">Create Invoice</button>
        <!-- quick filter submit: reload GET with current picks -->
        <a class="btn btn-outline-secondary"
   href="?client={{ form.client.value|default:'' }}&matter={{ form.matter.value|default:'' }}">
  Refresh WIP
</a>

      </div>
    </div>
  </form>
</main>
<footer>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const client = document.getElementById('id_inv_client');
  const matter = document.getElementById('id_inv_matter');
  const ajaxURL = "{% url 'ajax-matter-options' %}";

  const params = new URLSearchParams(window.location.search);
  const currentClient = params.get('client') || '';
  const currentMatter = params.get('matter') || '';

  async function loadMatters(cid, selectValue = '') {
    if (!matter) return;
    if (!cid) {
      matter.innerHTML = '<option value="">— Select matter —</option>';
      return;
    }
    const r = await fetch(`${ajaxURL}?client=${encodeURIComponent(cid)}`, {
      headers: {'X-Requested-With': 'XMLHttpRequest'}
    });
    matter.innerHTML = await r.text();
    if (selectValue) {
      const opt = matter.querySelector(`option[value="${CSS.escape(selectValue)}"]`);
      if (opt) opt.selected = true;
    }
  }

  function reloadWith(clientVal, matterVal) {
    const qs = new URLSearchParams();
    if (clientVal) qs.set('client', clientVal);
    if (matterVal) qs.set('matter', matterVal);
    window.location.search = qs.toString();
  }

  // Initial populate
  const initialClient = (client && client.value) || currentClient;
  if (initialClient) loadMatters(initialClient, currentMatter);

  if (client) {
    client.addEventListener('change', e => {
      const cid = e.target.value;
      loadMatters(cid);
      reloadWith(cid, '');
    });
  }
  if (matter) {
    matter.addEventListener('change', e => {
      const cid = client ? client.value : currentClient;
      reloadWith(cid, e.target.value);
    });
  }
});
</script>

</body>
</html>
