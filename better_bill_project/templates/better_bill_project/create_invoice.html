{% extends "base.html" %}
{% load static %}
{# templates/create_invoice.html #}

<!-- Page Title -->
{% block title %}Create Invoice{% endblock %}

<!-- Main Section -->
{% block content %}
<main class="container pt-5 pb-5">
    <!-- Page Title -->
   <h2 class="page-title create-inv-t">Create Invoice </h2>
<!-- Validation message if submission successful -->
  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      {% if "invoice" in message.tags %}
        <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}


  <form method="post" class="card shadow-sm mb-4">
    <div class="card-body">
      {% csrf_token %}

      <div class="row g-3">
  <!-- Invoice #: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Invoice #</label>
    <input class="form-control" value="{{ readonly_number }}" disabled>
  </div>

  <!-- Invoice date: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Invoice Date</label>
    <input class="form-control" value="{{ readonly_date }}" disabled>
  </div>

  <!-- Tax %: read-only display -->
  <div class="col-md-4">
    <label class="form-label">Tax %</label>
    <input class="form-control" value="{{ readonly_tax }}" disabled>
  </div>

  <div class="col-md-6">
    <label class="form-label" for="{{ form.client.id_for_label }}">Client</label>
    {{ form.client }}
  </div>
  <div class="col-md-6">
    <label class="form-label" for="{{ form.matter.id_for_label }}">Matter</label>
    {{ form.matter }}
  </div>

  <div class="col-12">
    <label class="form-label" for="{{ form.notes.id_for_label }}">Work Summary</label>
    {{ form.notes }}
  </div>
</div>
      <hr>
      <h5 class="mb-3">Select WIP items to include</h5>
      <p class="text-muted">Choose a Client (and optionally a Matter) to see unbilled WIP.</p>

      {% if wip_items %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:2rem"></th>
                <th>Created</th>
                <th>Matter</th>
                <th>Fee Earner</th>
                <th>Hours</th>
                <th>Activity</th>
                <th>Narrative</th>
              </tr>
            </thead>
            <tbody>
              {% for w in wip_items %}
              <tr>
                <td><input type="checkbox" name="wip_ids" value="{{ w.id }}"></td>
                <td>{{ w.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ w.matter.matter_number }}</td>
                <td>{{ w.fee_earner.initials }}</td>
                <td>{{ w.hours_worked }}</td>
                <td>{{ w.activity_code }}</td>
                <td class="text-truncate" style="max-width:420px">{{ w.narrative }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info">No unbilled WIP found for the current selection.</div>
      {% endif %}

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-success">Create Invoice</button>
        <!-- quick filter submit: reload GET with current picks -->
        <a class="btn btn-outline-secondary"
   href="?client={{ form.client.value|default:'' }}&matter={{ form.matter.value|default:'' }}">
  Refresh WIP
</a>

      </div>
    </div>
  </form>
</main>
<footer>
</footer>
{% endblock %}

<!-- Scripts (pulls in bootstrap)-->
{% block body_end %}
<!-- Custom JS -->
  <script src="{% static 'js/create_invoice.js' %}" defer></script>
{% endblock %}

