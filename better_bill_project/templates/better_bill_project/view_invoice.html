<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Billing - Invoice Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Custom CSS -->
     {% load static %}
     <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<header class="sticky-top">
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm" data-bs-theme="light">
    <div class="container">
      <!-- Brand -->
      <a class="navbar-brand fw-bold" href="{% url 'index' %}">Better Billing</a>

      <!-- Mobile toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Collapsible area -->
      <div class="collapse navbar-collapse" id="mainNav">
        {% with url_name=request.resolver_match.url_name %}
        <!-- Left side: primary nav -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'index' %}active{% endif %}"
               aria-current="{% if url_name == 'index' %}page{% endif %}"
               href="{% url 'index' %}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'record-time' %}active{% endif %}"
               aria-current="{% if url_name == 'record-time' %}page{% endif %}"
               href="{% url 'record-time' %}">Record Hours</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'create-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'create-invoice' %}page{% endif %}"
               href="{% url 'create-invoice' %}">Create Invoice</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'view-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'view-invoice' %}page{% endif %}"
               href="{% url 'view-invoice' %}">View Invoice</a>
          </li>

          {% if perms.better_bill_project.post_invoice %}
          <li class="nav-item">
            <a class="nav-link {% if url_name == 'post-invoice' %}active{% endif %}"
               aria-current="{% if url_name == 'post-invoice' %}page{% endif %}"
               href="{% url 'post-invoice' %}">Post/Delete Invoices</a>
          </li>
          {% endif %}
        </ul>
        {% endwith %}

        <!-- Right side: login/user info from partial -->
        <div class="navbar-nav ms-auto align-items-lg-center gap-2">
          {% include "partials/_topbar.html" %}
        </div>
      </div>
    </div>
  </nav>

</header>


  
    <main class="container py-4">
  <!-- Filters -->
  <form method="get" class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Invoice #</label>
          <input type="text" name="number" value="{{ filters.number }}" class="form-control" placeholder="e.g. 2025-0001">
        </div>
        <div class="col-md-3">
          <label class="form-label">Client</label>
          <select name="client" id="id_ledger_client" class="form-select">
            <option value="">— Any —</option>
            {% for c in clients %}
              <option value="{{ c.id }}" {% if filters.client|add:'' == c.id|stringformat:'s' %}selected{% endif %}>
                {{ c.client_number }} — {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Matter</label>
          <select name="matter" id="id_ledger_matter" class="form-select">
            <option value="">— Any —</option>
            {% for m in matters %}
              <option value="{{ m.id }}" {% if filters.matter|add:'' == m.id|stringformat:'s' %}selected{% endif %}>
                {{ m.matter_number }} — {{ m.description }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="">— Any —</option>
            <option value="draft"  {% if filters.status == 'draft' %}selected{% endif %}>Draft</option>
            <option value="posted" {% if filters.status == 'posted' %}selected{% endif %}>Posted</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">From</label>
          <input type="date" name="date_from" value="{{ filters.date_from }}" class="form-control">
        </div>
        <div class="col-md-3">
          <label class="form-label">To</label>
          <input type="date" name="date_to" value="{{ filters.date_to }}" class="form-control">
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary">Filter</button>
        <a class="btn btn-outline-secondary" href="{% url 'view-invoice' %}">Clear</a>
      </div>
    </div>
  </form>

  <!-- Results -->
  {% if page_obj.object_list %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Client</th>
            <th>Matter</th>
            <th class="text-end">Subtotal</th>
            <th class="text-end">Tax</th>
            <th class="text-end">Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for inv in page_obj %}
            {% with led=inv.ledger %}
            <tr>
              <td>{{ inv.number }}</td>
              <td>{{ inv.invoice_date|date:"Y-m-d" }}</td>
              <td>{{ inv.client.client_number }} — {{ inv.client.name }}</td>
              <td>{% if inv.matter %}{{ inv.matter.matter_number }} — {{ inv.matter.description }}{% else %}—{% endif %}</td>
              <td class="text-end">{% if led %}£{{ led.subtotal|floatformat:2 }}{% else %}—{% endif %}</td>
              <td class="text-end">{% if led %}£{{ led.tax|floatformat:2 }}{% else %}—{% endif %}</td>
              <td class="text-end fw-semibold">{% if led %}£{{ led.total|floatformat:2 }}{% else %}—{% endif %}</td>
              <td>{% if led %}{{ led.status|title }}{% else %}—{% endif %}</td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="4" class="text-end">Page totals:</th>
            <th class="text-end">£{{ page_subtotal|floatformat:2 }}</th>
            <th class="text-end">£{{ page_tax|floatformat:2 }}</th>
            <th class="text-end">£{{ page_total|floatformat:2 }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Pagination -->
    <nav class="mt-3">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filters.number %}&number={{ filters.number }}{% endif %}{% if filters.client %}&client={{ filters.client }}{% endif %}{% if filters.matter %}&matter={{ filters.matter }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">Previous</a>
          </li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filters.number %}&number={{ filters.number }}{% endif %}{% if filters.client %}&client={{ filters.client }}{% endif %}{% if filters.matter %}&matter={{ filters.matter }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_from %}&date_from={{ filters.date_from }}{% endif %}{% if filters.date_to %}&date_to={{ filters.date_to }}{% endif %}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <div class="alert alert-info">No invoices found for the current filters.</div>
  {% endif %}
</main>
    
    <footer>
        <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    
<script>
  // Optional: narrow Matter dropdown when Client changes
  document.addEventListener('DOMContentLoaded', function() {
    const client = document.getElementById('id_ledger_client');
    const matter = document.getElementById('id_ledger_matter');
    const url = "{% url 'ajax-matter-options' %}";
    async function loadMatters(cid){
      const r = await fetch(`${url}?client=${cid}`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      matter.innerHTML = await r.text();
      // Preserve selected value if it exists in new list
      const current = "{{ filters.matter }}";
      if (current) { Array.from(matter.options).forEach(o => { if (o.value === current) o.selected = true; }); }
    }
    if (client) {
      client.addEventListener('change', e => {
        const cid = e.target.value;
        if (cid) loadMatters(cid);
        else matter.innerHTML = '<option value="">— Any —</option>';
      });
      if (client.value) loadMatters(client.value);
    }
  });
</script>
</footer>


    </body>
</html>